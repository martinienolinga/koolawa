function parseSQLCode(a){var b="text/x-mariadb";workspaceQueries.queries[a].editor=CodeMirror.fromTextArea(document.getElementById("codesql"+a),{mode:b,indentWithTabs:true,smartIndent:true,lineNumbers:true,matchBrackets:true,autofocus:true,extraKeys:{"Ctrl-Space":"autocomplete"},hintOptions:{tables:{users:{name:null,score:null,birthDate:null},countries:{name:null,population:null,size:null}}}})}var clipboardQueries=undefined;var workspaceQueries={name:"queries",current:null,currentTab:null,queries:[],propertyData:null,properySource:null,init:function(){Ext.define("variableModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"value",type:"string"}]});Ext.define("queryModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"alias",type:"string"},{name:"groupid",type:"int"},{name:"content",type:"string"},{name:"description",type:"string"},{name:"motscles",type:"string"},{name:"datasourceid",type:"string"},{name:"publiee",type:"boolean"}]});Ext.define("treeModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"nodek",type:"string"},{name:"text",type:"string"},{name:"groupid",type:"int"}]})},menuQueries:new Ext.menu.Menu({items:[{text:"Modifier la requête",key:"modquery"},{text:"Supprimer la requête",key:"delquery"},{xtype:"menuseparator"},{text:"Copier",key:"copyquery",iconCls:"icon-copy"},{text:"Couper",key:"cutquery",iconCls:"icon-cut"}],listeners:{click:function(c,a){switch(a.key){case"modquery":workspaceQueries.gotoQuery(workspaceQueries.menuQueries.rec);break;case"delquery":var b=workspaceQueries.menuQueries.rec;Ext.MessageBox.show({title:"Totem : Suppression de requête",msg:"Etes-vous certain de vouloir supprimer la requête [ "+b.raw.alias+" ] ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceQueries.itemQueries,{msg:"Suppression en cours ..."});e.show();symfony("delete","query","query",{id:b.raw.Id},function(g){b.remove(true);workspaceQueries.autoCloseCenterTab();f.hide();e.hide()})}}});break;case"copyquery":workspaceQueries.copy(workspaceQueries.menuQueries.rec);break;case"cutquery":workspaceQueries.cut(workspaceQueries.menuQueries.rec);break}}}}),menuGroupQueries:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{text:"Modifier ce groupe",key:"modgroup"},{text:"Supprimer ce groupe",key:"delgroup"},{xtype:"menuseparator"},{text:"Copier",key:"copygroup",iconCls:"icon-copy-folder"},{text:"Couper",key:"cutgroup",iconCls:"icon-cut"},{id:"querypaste",text:"Coller",key:"paste",disabled:true,iconCls:"icon-paste"},{xtype:"menuseparator"},{text:"Ajouter une requête",key:"addquery"}],listeners:{click:function(c,a){switch(a.key){case"copygroup":workspaceQueries.copy(workspaceQueries.menuGroupQueries.rec);break;case"cutgroup":workspaceQueries.cut(workspaceQueries.menuGroupQueries.rec);break;case"addquery":workspaceQueries.newQuery(workspaceQueries.menuGroupQueries.rec);break;case"paste":workspaceQueries.paste(workspaceQueries.menuGroupQueries.rec);break;case"addgroup":workspaceQueries.groupForm.load("Nouveau groupe","new",workspaceQueries.menuGroupQueries.rec).show();break;case"modgroup":workspaceQueries.groupForm.load("Modifier un groupe","update",workspaceQueries.menuGroupQueries.rec).show();break;case"delgroup":var b=workspaceQueries.menuGroupQueries.rec;Ext.MessageBox.show({title:"Totem : Suppression de groupe",msg:"Etes-vous certain de vouloir supprimer le groupe [ "+b.raw.title+" ] et tous les éléments qu'il contient ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceQueries.itemQueries,{msg:"Suppression en cours ..."});e.show();symfony("delete","group","query",{id:b.raw.Id},function(g){b.remove(true);workspaceQueries.autoCloseCenterTab();f.hide();e.hide()})}}});break}}}}),copy:function(a){clipboardQueries={item:a,action:"copy"};Ext.getCmp("querypaste").setDisabled(false);if(a.raw.nodek=="groupquery"){Ext.getCmp("querypasteroot").setDisabled(false)}},cut:function(a){clipboardQueries={item:a,action:"cut"};Ext.getCmp("querypaste").setDisabled(false);if(a.raw.nodek=="groupquery"){Ext.getCmp("querypasteroot").setDisabled(false)}},paste:function(d){var a=clipboardQueries.item;if(clipboardQueries.action=="cut"){if(clipboardQueries.item.raw.nodek=="query"){var b={id:clipboardQueries.item.raw.Id,groupid:d.raw.Id};symfony("save","query","query",b,function(e){if(workspaceQueries.current!=null&&workspaceQueries.current.Id==b.id){workspaceQueries.current.groupid=b.groupid}d.appendChild(a)})}else{if(clipboardQueries.item.raw.nodek=="groupquery"){var c={id:clipboardQueries.item.raw.Id,groupid:d.raw.Id};symfony("save","group","query",c,function(e){d.appendChild(a)})}}}else{if(clipboardQueries.item.raw.nodek=="query"){var b={id:clipboardQueries.item.raw.Id,groupid:d.raw.Id};symfony("clone","query","query",b,function(e){d.appendChild(e.data)})}else{if(clipboardQueries.item.raw.nodek=="groupquery"){var c={id:clipboardQueries.item.raw.Id,groupid:d.raw.Id};symfony("clone","group","query",c,function(e){d.appendChild(e.data)})}}}clipboardQueries=null;Ext.getCmp("querypaste").setDisabled(true);Ext.getCmp("querypasteroot").setDisabled(true)},menuRootGroupQueries:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{xtype:"menuseparator"},{id:"querypasteroot",text:"Coller",key:"paste",disabled:true,iconCls:"icon-paste"}],listeners:{click:function(b,a){switch(a.key){case"addgroup":workspaceQueries.groupForm.load("Nouveau groupe","new",workspaceQueries.menuGroupQueries.rec).show();break;case"paste":workspaceQueries.paste(workspaceQueries.menuGroupQueries.rec);break}}}}),groupForm:{load:function(f,c,e){var d=null;var b=null;if(c=="new"){d={raw:{Id:0,title:"",text:""}};b=e}if(c=="update"){d=e;b=e.parentNode}var a=new Ext.form.Panel({defaults:{labelWidth:150},width:500,height:400,title:f,floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Name",name:"name",value:d.raw.title},{xtype:"displayfield",fieldLabel:"Parent",name:"parent",value:(b.raw.Id==0||b.raw.Id==null)?"(Racine)":b.raw.title},{xtype:"tabpanel",flex:1,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",items:[{title:"Info",items:[{xtype:"textfield",fieldLabel:"Country",name:"country"}]},{title:"Contact",items:[{xtype:"textfield",fieldLabel:"Email",name:"email"}]}]}],buttons:[{text:"Enregistrer",handler:function(){var h=a.items.get("name").value;var g=(b.raw.Id)?b.raw.Id:0;group={id:d.raw.Id,title:h,groupid:g};symfony("save","group","query",group,function(i){if(c=="new"){b.insertChild(-1,{Id:i.data.Id,title:group.title,text:group.title,iconCls:"tree-folder"});if(!b.isExpanded()){b.expand()}}if(c=="update"){d.set("text",group.title);d.raw.text=group.title;d.raw.title=group.title;d.commit()}a.close()})}},{text:"Annuler",handler:function(){a.close()}}]});return a}},autoCloseCenterTab:function(){centerPanel.items.each(function(b,a,c){if("query" in b&&b.query.Id!=0){var d={id:b.query.Id};symfony("exists","query","query",d,function(e){if(e.data.response=="false"){if(workspaceQueries.current.Id==d.id){workspaceQueries.current=null}centerPanel.remove(b)}})}})},newQuery:function(b){var a={groupid:b.raw.Id,title:"Nouvelle requête",content:"select * from table;"};symfony("save","query","query",a,function(c){var d=b.insertChild(-1,c.data.Id);workspaceQueries.gotoQuery(d)})},gotoQuery:function(a){workspaceQueries.getQuery(a.raw.Id,function(c){var b=false;centerPanel.items.each(function(f,e,g){if(f.query&&c.Id==f.query.Id){b=true;centerPanel.setActiveTab(f)}});if(!b){var d=Ext.create("Ext.Panel",{title:a.raw.alias,iconCls:"icon-sql",html:"<textarea id='codesql"+c.Id+"' name='codesql'>"+c.content+"</textarea>",closable:true,active:true,tbar:[{text:"Enregistrer",iconCls:"icon-save",key:"save",handler:workspaceQueries.task},{text:"Analyser",iconCls:"icon-analyse",key:"analyse",handler:workspaceQueries.task},{text:"Exécuter",iconCls:"icon-run",key:"run",handler:workspaceQueries.task},{text:"Exporter",iconCls:"icon-run",key:"run",handler:workspaceQueries.task,region:"east"}]});d.query=a.raw;d.rec=a;d.workspace=workspaceQueries;d.propertySource={"(name)":c.title,alias:c.alias,description:Ext.encode({description_resume:"",description_details:""}),motscles:c.motscles,datasourceid:c.datasourceid,publiee:c.publiee};symfony("get","columns","query",{id:a.raw.Id},function(e){var g=[];var f=[];$.each(e.data,function(h,i){g.push(i);if(i.printed){f.push(i)}});d.columnSource=Ext.create("Ext.data.Store",{fields:["Id","type","table","name","len","precision","ordre","displayed","printed","width"],data:g});d.coldata=f;centerPanel.add(d);centerPanel.setActiveTab(d);parseSQLCode(c.Id)})}})},onCenterTabChange:function(b,a){if("query" in a){workspaceQueries.current=a.query;workspaceQueries.propertyData.setSource(a.propertySource);workspaceQueries.gridColumns.unbindStore();workspaceQueries.gridColumns.bindStore(a.columnSource);workspaceQueries.gridResults.reconfigure(null,a.coldata)}},itemQueries:Ext.create("Ext.tree.Panel",{title:"Requêtes",store:Ext.create("Ext.data.TreeStore",{model:"treeModel",proxy:{type:"memory"}}),viewConfig:{plugins:{ptype:"treeviewdragdrop"},listeners:{beforedrop:function(d,f,e,b,a,c){if((b=="before"||b=="after")&&e.parentNode.raw.text=="Root"){if(f.records[0].raw.nodek=="query"){a.cancelDrop()}}},drop:function(b,e,d,a){if(e.records[0].raw.nodek=="groupquery"){var f={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","group","query",f,function(g){})}else{if(e.records[0].raw.nodek=="query"){var c={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","query","query",c,function(g){if(workspaceQueries.current.Id==c.id){workspaceQueries.current.groupid=c.groupid}})}}}}},rootVisible:false,listeners:{afterrender:function(a,b){var c=new Ext.LoadMask(workspaceQueries.itemQueries,{msg:"Veuillez patienter ..."});c.show();symfony("list","query","query",{},function(d){var f=workspaceQueries.itemQueries.getStore();var e=f.setRootNode({children:d.data});Ext.apply(workspaceQueries.itemQueries,{store:f});c.hide()})},itemdblclick:function(c,f,e,d,a){if(f.get("leaf")){var b=new Ext.LoadMask(centerPanel,{msg:"Chargement en cours ..."});b.show();symfony("get","query","query",{id:f.raw.Id},function(g){f.raw=g.data;workspaceQueries.gotoQuery(f);b.hide()})}},containercontextmenu:function(b,a){workspaceQueries.menuGroupQueries.rec=workspaceQueries.itemQueries.store.tree.root;workspaceQueries.menuRootGroupQueries.showAt(a.getXY());a.stopEvent()},itemcontextmenu:function(b,e,d,c,a){if(e.get("leaf")){workspaceQueries.menuQueries.rec=e;workspaceQueries.menuQueries.showAt(a.getXY())}else{workspaceQueries.menuGroupQueries.rec=e;workspaceQueries.menuGroupQueries.showAt(a.getXY())}a.stopEvent()}}}),setProperties:function(a){$.each(a,function(b,c){workspaceQueries.propertySource[b]=c});workspaceQueries.propertyData.setSource(workspaceQueries.propertySource)},set:function(a,b){currentWorkspace=workspaceQueries;bottomPanel.show();propertyPanel.removeAll();workspaceQueries.propertySource={"(name)":"name",alias:"alias",description:Ext.encode({description_resume:"",description_details:""}),motscles:"",datasourceid:"",publiee:true};symfony("list","datasrc","datasource",{},function(d){var e=[];$.each(d.data,function(f,g){e.push(g)});var c=Ext.create("Ext.data.Store",{fields:["Id","title"],data:e});workspaceQueries.setAfterLoad(a,c,b)})},setAfterLoad:function(b,a,c){workspaceQueries.currentTab=b.tab;workspaceQueries.propertyData=Ext.create("Ext.grid.property.Grid",{title:"Propriétés",propertyNames:{"(name)":"(Nom)",alias:"Alias",description:"Description",motscles:"Mots clés",datasourceid:"Source de données",publiee:"Publiée"},sourceConfig:{datasourceid:{renderer:function(d){a.data.each(function(g,e,f){if(g.raw.Id==d){d=g.raw.title}});return d}}},listeners:{propertychange:function(i,f,h,e){var g=centerPanel.getActiveTab();var d=h;if(f=="(name)"){d=replaceAll(" ","_",h)}if(f=="(name)"&&g.rec.raw.alias.trim()===""){g.rec.set("text",d);g.rec.raw.text=d;g.rec.raw.title=d;g.rec.commit();g.setTitle(h)}if(f=="alias"&&h.trim()!==""){g.rec.set("text",h);g.rec.raw.text=h;g.rec.raw.alias=h;g.rec.commit();g.setTitle(h)}}},customEditors:{description:{xtype:"descriptionfield"},groupe:{xtype:"combobox"},datasourceid:Ext.create("Ext.form.ComboBox",{store:a,queryMode:"local",displayField:"title",valueField:"Id",emptyText:"(Aucun)"})},customRenderers:{"(name)":function(d){return replaceAll(" ","_",d)},description:function(d){var g=Ext.decode(d),h=g.description_details,e=g.description_resume,f="";f+="<b>"+e+"</b>: ";f+="<i>"+h+"</i>";return f},publiee:function(d){if(d){return"Oui"}else{return"Non"}}},source:workspaceQueries.propertySource});propertyPanel.add(workspaceQueries.propertyData);workspaceQueries.propertyData.columns[0].width=150;propertyPanel.add(Ext.create("Ext.Panel",{title:"Historique",items:[]}));propertyPanel.add(aboutTab());propertyPanel.setActiveTab(workspaceQueries.propertyData);workspaceQueries.gridColumns=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1,dataIndex:"ordre"},{text:"Table",flex:1,sortable:1,dataIndex:"table"},{text:"Nom SQL",flex:1,sortable:1,dataIndex:"name"},{text:"Titre de la colonne",flex:1,sortable:1,dataIndex:"displayed",editor:"textfield"},{text:"Afficher",flex:1,sortable:1,dataIndex:"printed",editor:{xtype:"combobox",forceSelection:true,editable:false,triggerAction:"all",allowBlank:false,valueField:"value",displayField:"descr",store:Ext.create("Ext.data.Store",{fields:["descr","value"],data:[{descr:"Oui",value:true},{descr:"Non",value:false}]})},renderer:function(f,e,d){switch(f){case false:return"Non";case true:return"Oui"}}},{text:"Type",flex:1,sortable:1,dataIndex:"type",renderer:function(f,e,d){switch(f){case"STRING":return"Chaîne";case"INTEGER":return"Entier";case"DATE":return"Date";case"LONG":return"Entier long";case"TINY":return"Booléen";case"VAR_STRING":return"Chaîne";case"TEXT":return"Texte"}return f}},{text:"Longueur",flex:1,sortable:1,dataIndex:"len"},{text:"Précision",flex:1,sortable:1,dataIndex:"precision"}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})],listeners:{edit:function(f,g){if(g.field=="displayed"){g.record.raw.displayed=g.value}if(g.field=="printed"){g.record.raw.printed=g.value}var d={id:g.record.raw.Id,displayed:g.record.raw.displayed,printed:g.record.raw.printed};symfony("save","column","query",d,function(e){g.record.commit()})}}});workspaceQueries.gridResults=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1}]});workspaceQueries.gridVars=Ext.create("Ext.grid.Panel",{columnLines:true,selType:"checkboxmodel",selModel:{mode:"MULTI"},viewConfig:{stripeRows:true},columns:[{text:"Id",dataIndex:"Id",hidden:true},{text:"Nom",dataIndex:"name",flex:1,sortable:1,editor:{allowBlank:false}},{text:"Libellé",dataIndex:"title",flex:1,sortable:1,editor:{allowBlank:true}},{text:"Type",dataIndex:"type",flex:1,sortable:1,editor:{xtype:"combobox",forceSelection:true,editable:false,triggerAction:"all",allowBlank:false,valueField:"value",displayField:"descr",store:Ext.create("Ext.data.Store",{fields:["descr","value"],data:[{descr:"Chaîne",value:"STRING"},{descr:"Entier",value:"INTEGER"},{descr:"Date",value:"DATE"},{descr:"Booléen",value:"BOOLEAN"}]})},renderer:function(f,e,d){switch(f){case"STRING":return"Chaîne";case"INTEGER":return"Entier";case"DATE":return"Date";case"BOOLEAN":return"Booléen"}}},{text:"Valeur initiale",dataIndex:"value",flex:1,sortable:1,editor:{allowBlank:true}}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})],listeners:{edit:function(d,f){if(f.field=="name"){f.record.raw.name=f.value}if(f.field=="title"){f.record.raw.title=f.value}if(f.field=="type"){f.record.raw.type=f.value}if(f.field=="value"){f.record.raw.value=f.value}}}});bottomPanel.removeAll();workspaceQueries.parametreColonnes=Ext.create("Ext.Panel",{title:"Paramètres d'affichage des colonnes",iconCls:"tabs",closable:false,items:[workspaceQueries.gridColumns]});workspaceQueries.resultatsRequetes=Ext.create("Ext.Panel",{title:"Résultats requetes",iconCls:"tabs",closable:false,items:[workspaceQueries.gridResults],tbar:[{text:"Extraire",iconCls:"icon-export",key:"csv",handler:workspaceQueries.resulttask}]});workspaceQueries.variablesRequetes=Ext.create("Ext.Panel",{title:"Variables",iconCls:"tabs",closable:false,items:[workspaceQueries.gridVars],tbar:[{text:"Ajouter",iconCls:"icon-add",key:"add",handler:workspaceQueries.vartask},{text:"Recharger",iconCls:"icon-refresh",key:"load",handler:workspaceQueries.vartask},{text:"Enregistrer",iconCls:"icon-save",key:"save",handler:workspaceQueries.vartask},{text:"Supprimer",iconCls:"icon-delete",key:"delete",handler:workspaceQueries.vartask}]});workspaceQueries.variablesRequetes.Mask=new Ext.LoadMask(workspaceQueries.variablesRequetes,{msg:"Veuillez patienter ..."});if(workspaceQueries.currentTab.storeVariables!==undefined){workspaceQueries.gridVars.getView().bindStore(workspaceQueries.currentTab.storeVariables)}else{symfony("list","variable","query",{id:workspaceQueries.currentTab.rec.raw.Id},function(d){var e=[];$.each(d.data,function(f,g){e.push(g)});workspaceQueries.currentTab.storeVariables=Ext.create("Ext.data.Store",{fields:["Id","name","title","type","value"],data:e});workspaceQueries.gridVars.getView().bindStore(workspaceQueries.currentTab.storeVariables)})}bottomPanel.add(workspaceQueries.variablesRequetes);bottomPanel.add(workspaceQueries.parametreColonnes);bottomPanel.add(workspaceQueries.resultatsRequetes);bottomPanel.setActiveTab(workspaceQueries.variablesRequetes);c()},getQuery:function(b,a){symfony("get","query","query",{id:b},function(c){if(workspaceQueries.queries[c.data.Id]===undefined){workspaceQueries.queries[c.data.Id]={}}workspaceQueries.queries[c.data.Id]={};a(c.data)})},saveCurrent:function(d){var b=workspaceQueries.queries[workspaceQueries.current.Id].editor.getValue();workspaceQueries.current.content=b;workspaceQueries.current.title=replaceAll(" ","_",workspaceQueries.propertyData.source["(name)"]);workspaceQueries.current.alias=workspaceQueries.propertyData.source.alias;workspaceQueries.current.description=workspaceQueries.propertyData.source.description;workspaceQueries.current.motscles=workspaceQueries.propertyData.source.motscles;workspaceQueries.current.datasourceid=workspaceQueries.propertyData.source.datasourceid;workspaceQueries.current.publiee=workspaceQueries.propertyData.source.publiee;var c={id:workspaceQueries.current.Id,title:workspaceQueries.current.title,alias:workspaceQueries.current.alias,content:workspaceQueries.current.content,groupid:workspaceQueries.current.groupid,description:workspaceQueries.current.description,motscles:workspaceQueries.current.motscles,datasourceid:workspaceQueries.current.datasourceid,publiee:workspaceQueries.current.publiee};var a=new Ext.LoadMask(centerPanel,{msg:"Sauvegarde en cours ..."});a.show();symfony("save","query","query",c,function(e){if(d!==undefined){d(e.data)}a.hide()})},analyseCurrent:function(d){function b(e){workspaceQueries.saveCurrent(function(f){var g={id:f.Id,variables:e};symfony("analyse","query","query",g,function(h){var k=[];var j=[];$.each(h.data,function(l,m){k.push(m);if(m.printed){j.push(m)}});var i=Ext.create("Ext.data.Store",{fields:["Id","type","table","name","len","precision","ordre","displayed","printed","width"],data:k});workspaceQueries.gridColumns.unbindStore();workspaceQueries.gridColumns.bindStore(i);workspaceQueries.gridResults.reconfigure(null,j);if(d!==undefined){d(h.data,e)}})})}if(workspaceQueries.currentTab.storeVariables.data.items.length){var a=Ext.create("Ext.form.Panel",{renderTo:Ext.getBody(),id:"variableform",cls:"my-form-class",defaults:{labelWidth:150},floating:true,closable:true,modal:true,frame:true,title:"Valeurs des variables",bodyStyle:"padding: 10px 10px 0 10px;",items:[],buttons:[{text:"OK",formBind:true,handler:function(){b(a.getValues());a.close()}},{text:"Annuler",handler:function(){a.close()}}]});function c(e,f){e.xtype="textfield";switch(f){case"DATE":e.xtype="datefield";e.format="d/m/Y";break;case"BOOLEAN":e.xtype="combobox";e.forceSelection=true;e.editable=false;e.triggerAction="all";e.valueField="value";e.displayField="descr";e.store=Ext.create("Ext.data.Store",{fields:["descr","value"],data:[{descr:"Vrai",value:1},{descr:"Faux",value:0}]});e.renderer=function(i,h,g){switch(i){case 1:return"Vrai";case 0:return"Faux"}};break}return e}$.each(workspaceQueries.currentTab.storeVariables.data.items,function(e,f){var g={xtype:c(f.raw.type),fieldLabel:f.raw.title,name:f.raw.name,allowBlank:false,value:f.raw.value};g=c(g,f.raw.type);a.add(g)});a.show()}else{b([])}},saveVariables:function(d,b){if(b>=d.length){workspaceQueries.variablesRequetes.Mask.hide();return}var c=d[b];var a={id:c.raw.Id,name:c.raw.name,title:c.raw.title,type:c.raw.type,value:c.raw.value,queryid:workspaceQueries.currentTab.rec.raw.Id};symfony("save","variable","query",a,function(e){c.raw.Id=e.data.Id;c.commit();workspaceQueries.saveVariables(d,b+1)})},deleteVariables:function(d,b){if(b>=d.length){workspaceQueries.variablesRequetes.Mask.hide();return}var c=d[b];var a={id:c.raw.Id};symfony("delete","variable","query",a,function(e){workspaceQueries.currentTab.storeVariables.remove(c);workspaceQueries.deleteVariables(d,b+1)})},vartask:function(a){switch(a.key){case"save":var c=workspaceQueries.gridVars;var e=c.getSelectionModel().getSelection();if(e.length){workspaceQueries.variablesRequetes.Mask.show();workspaceQueries.saveVariables(e,0)}else{Ext.Msg.alert("Totem","Selectionnez les variables à enregistrer.")}break;case"add":var c=workspaceQueries.gridVars;var b=workspaceQueries.currentTab.storeVariables;var d=Ext.create("variableModel",{Id:0,name:"variable",title:"Variable",type:"STRING",value:""});b.insert(b.count(),d);c.editingPlugin.startEdit(d,1);break;case"load":workspaceQueries.variablesRequetes.Mask.show();symfony("list","variable","query",{id:workspaceQueries.currentTab.rec.raw.Id},function(f){var g=[];$.each(f.data,function(h,i){g.push(i)});workspaceQueries.currentTab.storeVariables=Ext.create("Ext.data.Store",{fields:["Id","name","title","type","value"],data:g});workspaceQueries.gridVars.getView().bindStore(workspaceQueries.currentTab.storeVariables);workspaceQueries.variablesRequetes.Mask.hide()});break;case"delete":var c=workspaceQueries.gridVars;var e=c.getSelectionModel().getSelection();if(e.length){workspaceQueries.variablesRequetes.Mask.show();workspaceQueries.deleteVariables(e,0)}else{Ext.Msg.alert("Totem","Selectionnez les variables à supprimer.")}break}},resulttask:function(b){switch(b.key){case"csv":var a=(window.location.href.indexOf("admin")>-1)?"./admin/":"./";window.location=a+"csv?id="+workspaceQueries.current.Id;break}},task:function(a){switch(a.key){case"save":workspaceQueries.saveCurrent();break;case"analyse":bottomPanel.setActiveTab(workspaceQueries.parametreColonnes);workspaceQueries.analyseCurrent();break;case"run":bottomPanel.setActiveTab(workspaceQueries.resultatsRequetes);workspaceQueries.analyseCurrent(function(b,d){var c={id:workspaceQueries.current.Id,variables:d};symfony("run","query","query",c,function(f){var e=[];$.each(b,function(i,j){if(j.printed){e.push(j.name)}});var g=[];$.each(f.data,function(i,j){g.push(j)});var h=Ext.create("Ext.data.Store",{fields:e,data:g});workspaceQueries.gridResults.unbindStore();workspaceQueries.gridResults.bindStore(h)})});break}}};