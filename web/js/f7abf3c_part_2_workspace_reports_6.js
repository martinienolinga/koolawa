function parseHTMLCode(a){var b="text/html";workspaceReports.reports[a].editor=CodeMirror.fromTextArea(document.getElementById("codehtml"+a),{mode:b,indentWithTabs:true,smartIndent:true,lineNumbers:true,matchBrackets:true,autofocus:true,extraKeys:{"Ctrl-Space":"autocomplete"},hintOptions:{tables:{users:{name:null,score:null,birthDate:null},countries:{name:null,population:null,size:null}}}})}var clipboardReports=undefined;var workspaceReports={name:"reports",current:null,reports:[],propertyData:null,properySource:null,init:function(){Ext.define("treeModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"nodek",type:"string"},{name:"text",type:"string"},{name:"groupid",type:"int"}]})},menuReports:new Ext.menu.Menu({items:[{text:"Modifier le rapport",key:"modreport"},{text:"Supprimer le rapport",key:"delreport"},{xtype:"menuseparator"},{text:"Copier",key:"copyreport"},{text:"Couper",key:"cutreport"}],listeners:{click:function(c,a){switch(a.key){case"modreport":workspaceReports.gotoReport(workspaceReports.menuReports.rec);break;case"delreport":var b=workspaceReports.menuReports.rec;Ext.MessageBox.show({title:"Totem : Suppression de rapport",msg:"Etes-vous certain de vouloir supprimer le rapport [ "+b.raw.title+" ] ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceReports.itemReports,{msg:"Suppression en cours ..."});e.show();symfony("delete","report","report",{id:b.raw.Id},function(g){b.remove(true);workspaceReports.autoCloseCenterTab();f.hide();e.hide()})}}});break;case"copyreport":workspaceReports.copy(workspaceReports.menuReports.rec);break;case"cutreport":workspaceReports.cut(workspaceReports.menuReports.rec);break}}}}),menuGroupReports:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{text:"Modifier ce groupe",key:"modgroup"},{text:"Supprimer ce groupe",key:"delgroup"},{xtype:"menuseparator"},{text:"Copier",key:"copygroup"},{text:"Couper",key:"cutgroup"},{id:"reportpaste",text:"Coller",key:"paste",disabled:true},{xtype:"menuseparator"},{text:"Ajouter un rapport",key:"addreport"},{text:"Générer un rapport",key:"wizardreport"}],listeners:{click:function(c,a){switch(a.key){case"copygroup":workspaceReports.copy(workspaceReports.menuGroupReports.rec);break;case"cutgroup":workspaceReports.cut(workspaceReports.menuGroupReports.rec);break;case"wizardreport":workspaceReports.wizardreport(workspaceReports.menuGroupReports.rec);break;case"addreport":workspaceReports.newReport(workspaceReports.menuGroupReports.rec);break;case"paste":workspaceReports.paste(workspaceReports.menuGroupReports.rec);break;case"addgroup":workspaceReports.groupForm.load("Nouveau groupe","new",workspaceReports.menuGroupReports.rec).show();break;case"modgroup":workspaceReports.groupForm.load("Modifier un groupe","update",workspaceReports.menuGroupReports.rec).show();break;case"delgroup":var b=workspaceReports.menuGroupReports.rec;Ext.MessageBox.show({title:"Totem : Suppression de groupe",msg:"Etes-vous certain de vouloir supprimer le groupe [ "+b.raw.title+" ] et tous les éléments qu'il contient ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceReports.itemReports,{msg:"Suppression en cours ..."});e.show();symfony("delete","group","report",{id:b.raw.Id},function(g){b.remove(true);workspaceReports.autoCloseCenterTab();f.hide();e.hide()})}}});break}}}}),wizardreport:function(a){var b=[];symfony("listall","query","query",{},function(c){b=c.data;var d=new Ext.form.Panel({defaults:{labelWidth:150},width:700,height:170,title:"Assistant de génération de rapport",floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Nom du rapport",allowBlank:false,name:"name"},{id:"query",anchor:"100%",fieldLabel:"Requête",xtype:"groupingcombobox",name:"query",allowBlank:false,groupField:["grouptree"],valueField:"Id",displayField:"text",displaySeparator:" ❱ ",queryMode:"local",editable:false,typeAhead:true,store:{fields:[{name:"Id",type:"int"},{name:"grouptree",type:"string"},{name:"text",type:"string"}],sorters:[{property:"grouptree",direction:"ASC"}],data:b}}],buttons:[{text:"Generer",formBind:true,handler:function(){var g=d.items.get("name").value;var e=d.items.get("query").getValue();var f={queryid:e,title:g,parentid:a.raw.Id};symfony("generate","report","report",f,function(h){a.appendChild(h.data);d.close()})}},{text:"Annuler",handler:function(){d.close()}}]});d.show()})},copy:function(a){clipboardReports={item:a,action:"copy"};Ext.getCmp("reportpaste").setDisabled(false);if(a.raw.nodek=="groupreport"){Ext.getCmp("reportpasteroot").setDisabled(false)}},cut:function(a){clipboardReports={item:a,action:"cut"};Ext.getCmp("reportpaste").setDisabled(false);if(a.raw.nodek=="groupreport"){Ext.getCmp("reportpasteroot").setDisabled(false)}},paste:function(d){var b=clipboardReports.item;if(clipboardReports.action=="cut"){if(clipboardReports.item.raw.nodek=="report"){var a={id:clipboardReports.item.raw.Id,groupid:d.raw.Id};symfony("save","report","report",a,function(e){if(workspaceReports.current!=null&&workspaceReports.current.Id==a.id){workspaceReports.current.groupid=a.groupid}d.appendChild(b)})}else{if(clipboardReports.item.raw.nodek=="groupreport"){var c={id:clipboardReports.item.raw.Id,groupid:d.raw.Id};symfony("save","group","report",c,function(e){d.appendChild(b)})}}}else{if(clipboardReports.item.raw.nodek=="report"){var a={id:clipboardReports.item.raw.Id,groupid:d.raw.Id};symfony("clone","report","report",a,function(e){d.appendChild(e.data)})}else{if(clipboardReports.item.raw.nodek=="groupreport"){var c={id:clipboardReports.item.raw.Id,groupid:d.raw.Id};symfony("clone","group","report",c,function(e){d.appendChild(e.data)})}}}clipboardReports=null;Ext.getCmp("reportpaste").setDisabled(true);Ext.getCmp("reportpasteroot").setDisabled(true)},menuRootGroupReports:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{xtype:"menuseparator"},{id:"reportpasteroot",text:"Coller",key:"paste",disabled:true}],listeners:{click:function(b,a){switch(a.key){case"addgroup":workspaceReports.groupForm.load("Nouveau groupe","new",workspaceReports.menuGroupReports.rec).show();break;case"paste":workspaceReports.paste(workspaceReports.menuGroupReports.rec);break}}}}),groupForm:{load:function(f,c,e){var d=null;var b=null;if(c=="new"){d={raw:{Id:0,title:"",text:""}};b=e}if(c=="update"){d=e;b=e.parentNode}var a=new Ext.form.Panel({defaults:{labelWidth:150},width:500,height:400,title:f,floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Name",name:"name",value:d.raw.title},{xtype:"displayfield",fieldLabel:"Parent",name:"parent",value:(b.raw.Id==0||b.raw.Id==null)?"(Racine)":b.raw.title},{xtype:"tabpanel",flex:1,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",items:[{title:"Info",items:[{xtype:"textfield",fieldLabel:"Country",name:"country"}]},{title:"Contact",items:[{xtype:"textfield",fieldLabel:"Email",name:"email"}]}]}],buttons:[{text:"Enregistrer",handler:function(){var h=a.items.get("name").value;var g=(b.raw.Id)?b.raw.Id:0;group={id:d.raw.Id,title:h,groupid:g};symfony("save","group","report",group,function(i){if(c=="new"){b.insertChild(-1,{Id:i.data.Id,title:group.title,text:group.title});if(!b.isExpanded()){b.expand()}}if(c=="update"){d.set("text",group.title);d.raw.text=group.title;d.raw.title=group.title;d.commit()}a.close()})}},{text:"Annuler",handler:function(){a.close()}}]});return a}},autoCloseCenterTab:function(){centerPanel.items.each(function(c,b,d){if("report" in c&&c.report.Id!=0){var a={id:c.report.Id};symfony("exists","report","report",a,function(e){if(e.data.response=="false"){if(workspaceReports.current.Id==a.id){workspaceReports.current=null}centerPanel.remove(c)}})}})},newReport:function(b){var a={groupid:b.raw.Id,title:"Nouveau rapport",content:"<html>\n\t<body>\n\t\tContenu du rapport\n\t</body>\n</html>"};symfony("save","report","report",a,function(c){var d=b.insertChild(-1,c.data);workspaceReports.gotoReport(d)})},gotoReport:function(a){workspaceReports.getReport(a.raw.Id,function(b){var c=false;centerPanel.items.each(function(f,e,g){if(f.report&&b.Id==f.report.Id){c=true;centerPanel.setActiveTab(f)}});if(!c){var d=Ext.create("Ext.Panel",{title:a.raw.text,iconCls:"icon-report",html:"<textarea id='codehtml"+b.Id+"' name='codehtml'>"+b.content+"</textarea>",closable:true,active:true,tbar:[{text:"Enregistrer",key:"save",handler:workspaceReports.task},{text:"Aperçu",key:"apercu",handler:workspaceReports.task},{text:"Exécuter",key:"run",handler:workspaceReports.task}]});d.report=a.raw;d.rec=a;d.workspace=workspaceReports;d.propertySource={"(name)":b.title,description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};centerPanel.add(d);centerPanel.setActiveTab(d);parseHTMLCode(b.Id)}})},onCenterTabChange:function(b,a){if("report" in a){workspaceReports.current=a.report;workspaceReports.propertyData.setSource(a.propertySource)}},itemReports:Ext.create("Ext.tree.Panel",{title:"Rapports",store:Ext.create("Ext.data.TreeStore",{model:"treeModel",proxy:{type:"memory"}}),viewConfig:{plugins:{ptype:"treeviewdragdrop"},listeners:{beforedrop:function(d,f,e,b,a,c){if((b=="before"||b=="after")&&e.parentNode.raw.text=="Root"){if(f.records[0].raw.nodek=="report"){a.cancelDrop()}}},drop:function(c,e,d,b){if(e.records[0].raw.nodek=="groupreport"){var f={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","group","report",f,function(g){})}else{if(e.records[0].raw.nodek=="report"){var a={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","report","report",a,function(g){if(workspaceReports.current.Id==a.id){workspaceReports.current.groupid=a.groupid}})}}}}},rootVisible:false,listeners:{afterrender:function(a,b){var c=new Ext.LoadMask(workspaceReports.itemReports,{msg:"Veuillez patienter ..."});c.show();symfony("list","report","report",{},function(d){var f=workspaceReports.itemReports.getStore();var e=f.setRootNode({children:d.data});Ext.apply(workspaceReports.itemReports,{store:f});c.hide()})},itemdblclick:function(c,f,e,d,a){if(f.get("leaf")){var b=new Ext.LoadMask(centerPanel,{msg:"Chargement en cours ..."});b.show();symfony("get","report","report",{id:f.raw.Id},function(g){f.raw=g.data;workspaceReports.gotoReport(f);b.hide()})}},containercontextmenu:function(b,a){workspaceReports.menuGroupReports.rec=workspaceReports.itemReports.store.tree.root;workspaceReports.menuRootGroupReports.showAt(a.getXY());a.stopEvent()},itemcontextmenu:function(b,e,d,c,a){if(e.get("leaf")){workspaceReports.menuReports.rec=e;workspaceReports.menuReports.showAt(a.getXY())}else{workspaceReports.menuGroupReports.rec=e;workspaceReports.menuGroupReports.showAt(a.getXY())}a.stopEvent()}}}),setProperties:function(a){$.each(a,function(b,c){workspaceReports.propertySource[b]=c});workspaceReports.propertyData.setSource(workspaceReports.propertySource)},set:function(b,d){currentWorkspace=workspaceReports;bottomPanel.show();propertyPanel.removeAll();workspaceReports.propertySource={"(name)":"name",description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};workspaceReports.propertyData=Ext.create("Ext.grid.property.Grid",{title:"Propriétés",propertyNames:{"(name)":"(Nom)",description:"Description",motscles:"Mots clés",environnement:"Environnement",nodek:"Groupe",publiee:"Publiée"},listeners:{propertychange:function(k,h,j,g){if(h=="(name)"){var i=centerPanel.getActiveTab();i.rec.set("text",j);i.rec.raw.text=j;i.rec.raw.title=j;i.rec.commit();i.setTitle(j)}}},customEditors:{description:{xtype:"descriptionfield"},groupe:{xtype:"combobox"},environnement:{xtype:"combobox"}},customRenderers:{description:function(g){var j=Ext.decode(g),k=j.description_details,h=j.description_resume,i="";i+="<b>"+h+"</b>: ";i+="<i>"+k+"</i>";return i}},source:workspaceReports.propertySource});propertyPanel.add(workspaceReports.propertyData);propertyPanel.add(aboutTab());propertyPanel.setActiveTab(workspaceReports.propertyData);var f=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1},{text:"Titre de la colonne",flex:1,sortable:1},{text:"Cadrage",flex:1,sortable:1},{text:"Format de date",flex:1,sortable:1},{text:"Largeur de la colonne",flex:1,sortable:1}]});var e=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1}]});bottomPanel.removeAll();var c=Ext.create("Ext.Panel",{title:"Paramètres d'affichage des colonnes",iconCls:"tabs",closable:false,items:[f]});var a=Ext.create("Ext.Panel",{title:"Résultats rapports",iconCls:"tabs",html:"center south",closable:false,items:[e]});bottomPanel.add(c);bottomPanel.add(a);bottomPanel.setActiveTab(c);d()},getReport:function(b,a){symfony("get","report","report",{id:b},function(c){if(workspaceReports.reports[c.data.Id]===undefined){workspaceReports.reports[c.data.Id]={}}a(c.data)})},task:function(d){switch(d.key){case"save":var f=workspaceReports.reports[workspaceReports.current.Id].editor.getValue();workspaceReports.current.content=f;var g=workspaceReports.propertyData.source["(name)"];workspaceReports.current.title=g;var b={id:workspaceReports.current.Id,title:workspaceReports.current.title,content:workspaceReports.current.content,groupid:workspaceReports.current.groupid};var a=new Ext.LoadMask(centerPanel,{msg:"Sauvegarde en cours ..."});a.show();symfony("save","report","report",b,function(h){a.hide()});break;case"apercu":var e=new Ext.form.Panel({defaults:{labelWidth:150},width:800,height:600,title:"Aperçu du rapport",floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",layout:{type:"vbox",align:"stretch"},html:"",buttons:[{text:"Imprimer",handler:function(){var h=(window.location.href.indexOf("admin")>-1)?"./admin/":"./";window.location=h+"report?id="+workspaceReports.current.Id}},{text:"Fermer",handler:function(){e.close()}}]});e.show();var a=new Ext.LoadMask(e,{msg:"Chargement en cours ..."});a.show();var b={id:workspaceReports.current.Id};symfony("run","report","report",b,function(h){e.update(h.data.html);a.hide()});break;case"run":var c=(window.location.href.indexOf("admin")>-1)?"./admin/":"./";window.location=c+"report?id="+workspaceReports.current.Id;break}}};