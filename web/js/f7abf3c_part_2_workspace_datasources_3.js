var clipboardDatasources=undefined;var workspaceDatasources={name:"datasources",current:null,datasources:[],propertyData:null,properySource:null,init:function(){Ext.define("datasourceModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"groupid",type:"int"},{name:"driver",type:"string"},{name:"host",type:"string"},{name:"datastore",type:"string"},{name:"user",type:"string"},{name:"password",type:"string"}]});Ext.define("treeModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"nodek",type:"string"},{name:"text",type:"string"},{name:"groupid",type:"int"}]})},drivers:Ext.create("Ext.data.Store",{fields:["title","value"],data:[{title:"MySQL",value:"MYSQL"},{title:"Microsoft SQLServer",value:"MSSQL"},{title:"Oracle",value:"ORACLE"},{title:"PostgreSQL",value:"PGSQL"}]}),menuDatasources:new Ext.menu.Menu({items:[{text:"Modifier la source de données",key:"moddatasource"},{text:"Supprimer la source de données",key:"deldatasource"},{xtype:"menuseparator"},{text:"Copier",key:"copydatasource"},{text:"Couper",key:"cutdatasource"}],listeners:{click:function(c,a){switch(a.key){case"moddatasource":workspaceDatasources.gotoDatasource(workspaceDatasources.menuDatasources.rec);break;case"deldatasource":var b=workspaceDatasources.menuDatasources.rec;Ext.MessageBox.show({title:"Totem : Suppression de source de données",msg:"Etes-vous certain de vouloir supprimer la source de données [ "+b.raw.title+" ] ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceDatasources.itemDatasources,{msg:"Suppression en cours ..."});e.show();symfony("delete","datasource","datasource",{id:b.raw.Id},function(g){b.remove(true);workspaceDatasources.autoCloseCenterTab();f.hide();e.hide()})}}});break;case"copydatasource":workspaceDatasources.copy(workspaceDatasources.menuDatasources.rec);break;case"cutdatasource":workspaceDatasources.cut(workspaceDatasources.menuDatasources.rec);break}}}}),menuGroupDatasources:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{text:"Modifier ce groupe",key:"modgroup"},{text:"Supprimer ce groupe",key:"delgroup"},{xtype:"menuseparator"},{text:"Copier",key:"copygroup"},{text:"Couper",key:"cutgroup"},{id:"datasourcepaste",text:"Coller",key:"paste",disabled:true},{xtype:"menuseparator"},{text:"Ajouter une source de données",key:"adddatasource"}],listeners:{click:function(c,a){switch(a.key){case"copygroup":workspaceDatasources.copy(workspaceDatasources.menuGroupDatasources.rec);break;case"cutgroup":workspaceDatasources.cut(workspaceDatasources.menuGroupDatasources.rec);break;case"adddatasource":workspaceDatasources.newDatasource(workspaceDatasources.menuGroupDatasources.rec);break;case"paste":workspaceDatasources.paste(workspaceDatasources.menuGroupDatasources.rec);break;case"addgroup":workspaceDatasources.groupForm.load("Nouveau groupe","new",workspaceDatasources.menuGroupDatasources.rec).show();break;case"modgroup":workspaceDatasources.groupForm.load("Modifier un groupe","update",workspaceDatasources.menuGroupDatasources.rec).show();break;case"delgroup":var b=workspaceDatasources.menuGroupDatasources.rec;Ext.MessageBox.show({title:"Totem : Suppression de groupe",msg:"Etes-vous certain de vouloir supprimer le groupe [ "+b.raw.title+" ] et tous les éléments qu'il contient ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceDatasources.itemDatasources,{msg:"Suppression en cours ..."});e.show();symfony("delete","group","datasource",{id:b.raw.Id},function(g){b.remove(true);workspaceDatasources.autoCloseCenterTab();f.hide();e.hide()})}}});break}}}}),copy:function(a){clipboardDatasources={item:a,action:"copy"};Ext.getCmp("datasourcepaste").setDisabled(false);if(a.raw.nodek=="groupdatasource"){Ext.getCmp("datasourcepasteroot").setDisabled(false)}},cut:function(a){clipboardDatasources={item:a,action:"cut"};Ext.getCmp("datasourcepaste").setDisabled(false);if(a.raw.nodek=="groupdatasource"){Ext.getCmp("datasourcepasteroot").setDisabled(false)}},paste:function(d){var b=clipboardDatasources.item;if(clipboardDatasources.action=="cut"){if(clipboardDatasources.item.raw.nodek=="datasource"){var a={id:clipboardDatasources.item.raw.Id,groupid:d.raw.Id};symfony("save","datasource","datasource",a,function(e){if(workspaceDatasources.current!=null&&workspaceDatasources.current.Id==a.id){workspaceDatasources.current.groupid=a.groupid}d.appendChild(b)})}else{if(clipboardDatasources.item.raw.nodek=="groupdatasource"){var c={id:clipboardDatasources.item.raw.Id,groupid:d.raw.Id};symfony("save","group","datasource",c,function(e){d.appendChild(b)})}}}else{if(clipboardDatasources.item.raw.nodek=="datasource"){var a={id:clipboardDatasources.item.raw.Id,groupid:d.raw.Id};symfony("clone","datasource","datasource",a,function(e){d.appendChild(e.data)})}else{if(clipboardDatasources.item.raw.nodek=="groupdatasource"){var c={id:clipboardDatasources.item.raw.Id,groupid:d.raw.Id};symfony("clone","group","datasource",c,function(e){d.appendChild(e.data)})}}}clipboardDatasources=null;Ext.getCmp("datasourcepaste").setDisabled(true);Ext.getCmp("datasourcepasteroot").setDisabled(true)},menuRootGroupDatasources:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{xtype:"menuseparator"},{id:"datasourcepasteroot",text:"Coller",key:"paste",disabled:true}],listeners:{click:function(b,a){switch(a.key){case"addgroup":workspaceDatasources.groupForm.load("Nouveau groupe","new",workspaceDatasources.menuGroupDatasources.rec).show();break;case"paste":workspaceDatasources.paste(workspaceDatasources.menuGroupDatasources.rec);break}}}}),groupForm:{load:function(f,c,e){var d=null;var b=null;if(c=="new"){d={raw:{Id:0,title:"",text:""}};b=e}if(c=="update"){d=e;b=e.parentNode}var a=new Ext.form.Panel({defaults:{labelWidth:150},width:500,height:400,title:f,floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Name",name:"name",value:d.raw.title},{xtype:"displayfield",fieldLabel:"Parent",name:"parent",value:(b.raw.Id==0||b.raw.Id==null)?"(Racine)":b.raw.title},{xtype:"tabpanel",flex:1,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",items:[{title:"Info",items:[{xtype:"textfield",fieldLabel:"Country",name:"country"}]},{title:"Contact",items:[{xtype:"textfield",fieldLabel:"Email",name:"email"}]}]}],buttons:[{text:"Enregistrer",handler:function(){var h=a.items.get("name").value;var g=(b.raw.Id)?b.raw.Id:0;group={id:d.raw.Id,title:h,groupid:g};symfony("save","group","datasource",group,function(i){if(c=="new"){b.insertChild(-1,{Id:i.data.Id,title:group.title,text:group.title});if(!b.isExpanded()){b.expand()}}if(c=="update"){d.set("text",group.title);d.raw.text=group.title;d.raw.title=group.title;d.commit()}a.close()})}},{text:"Annuler",handler:function(){a.close()}}]});return a}},autoCloseCenterTab:function(){centerPanel.items.each(function(c,b,d){if("datasource" in c&&c.datasource.Id!=0){var a={id:c.datasource.Id};symfony("exists","datasource","datasource",a,function(e){if(e.data.response=="false"){if(workspaceDatasources.current.Id==a.id){workspaceDatasources.current=null}centerPanel.remove(c)}})}})},newDatasource:function(b){var a={groupid:b.raw.Id,title:"Nouvelle source de données"};symfony("save","datasource","datasource",a,function(c){var d=b.insertChild(-1,c.data);workspaceDatasources.gotoDatasource(d)})},gotoDatasource:function(a){workspaceDatasources.getDatasource(a.raw.Id,function(b){var c=false;centerPanel.items.each(function(f,e,g){if(f.datasource&&b.Id==f.datasource.Id){c=true;centerPanel.setActiveTab(f)}});if(!c){var d=Ext.create("Ext.Panel",{title:a.raw.text,iconCls:"icon-database",html:"contenu",closable:true,active:true,tbar:[{text:"Enregistrer",key:"save",handler:workspaceDatasources.task},{text:"Tester",key:"test",handler:workspaceDatasources.task}]});d.datasource=a.raw;d.rec=a;d.workspace=workspaceDatasources;d.propertySource={"(name)":b.title,description:Ext.encode({description_resume:"",description_details:""}),driver:"ORACLE",host:b.host,datastore:b.datastore,user:b.user,password:b.password};centerPanel.add(d);centerPanel.setActiveTab(d)}})},onCenterTabChange:function(b,a){if("datasource" in a){workspaceDatasources.current=a.datasource;workspaceDatasources.propertyData.setSource(a.propertySource)}},itemDatasources:Ext.create("Ext.tree.Panel",{title:"Sources de données",store:Ext.create("Ext.data.TreeStore",{model:"treeModel",proxy:{type:"memory"}}),viewConfig:{plugins:{ptype:"treeviewdragdrop"},listeners:{beforedrop:function(d,f,e,b,a,c){if((b=="before"||b=="after")&&e.parentNode.raw.text=="Root"){if(f.records[0].raw.nodek=="datasource"){a.cancelDrop()}}},drop:function(c,e,d,b){if(e.records[0].raw.nodek=="groupdatasource"){var f={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","group","datasource",f,function(g){})}else{if(e.records[0].raw.nodek=="datasource"){var a={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","datasource","datasource",a,function(g){if(workspaceDatasources.current.Id==a.id){workspaceDatasources.current.groupid=a.groupid}})}}}}},rootVisible:false,listeners:{afterrender:function(a,b){var c=new Ext.LoadMask(workspaceDatasources.itemDatasources,{msg:"Veuillez patienter ..."});c.show();symfony("list","datasource","datasource",{},function(d){var f=workspaceDatasources.itemDatasources.getStore();var e=f.setRootNode({children:d.data});Ext.apply(workspaceDatasources.itemDatasources,{store:f});c.hide()})},itemdblclick:function(c,f,e,d,a){if(f.get("leaf")){var b=new Ext.LoadMask(centerPanel,{msg:"Chargement en cours ..."});b.show();symfony("get","datasource","datasource",{id:f.raw.Id},function(g){f.raw=g.data;workspaceDatasources.gotoDatasource(f);b.hide()})}},containercontextmenu:function(b,a){workspaceDatasources.menuGroupDatasources.rec=workspaceDatasources.itemDatasources.store.tree.root;workspaceDatasources.menuRootGroupDatasources.showAt(a.getXY());a.stopEvent()},itemcontextmenu:function(b,e,d,c,a){if(e.get("leaf")){workspaceDatasources.menuDatasources.rec=e;workspaceDatasources.menuDatasources.showAt(a.getXY())}else{workspaceDatasources.menuGroupDatasources.rec=e;workspaceDatasources.menuGroupDatasources.showAt(a.getXY())}a.stopEvent()}}}),setProperties:function(a){$.each(a,function(b,c){workspaceDatasources.propertySource[b]=c});workspaceDatasources.propertyData.setSource(workspaceDatasources.propertySource)},set:function(b,d){currentWorkspace=workspaceDatasources;bottomPanel.hide();propertyPanel.removeAll();workspaceDatasources.propertySource={"(name)":"name",description:Ext.encode({description_resume:"",description_details:""}),driver:"",host:"",datastore:"",user:"",password:""};workspaceDatasources.propertyData=Ext.create("Ext.grid.property.Grid",{title:"Propriétés",sortableColumns:false,propertyNames:{"(name)":"(Nom)",description:"Description",driver:"Pilote",host:"Hôte",datastore:"Schéma",user:"Utilisateur",password:"Mot de passe"},listeners:{propertychange:function(k,h,j,g){if(h=="(name)"){var i=centerPanel.getActiveTab();i.rec.set("text",j);i.rec.raw.text=j;i.rec.raw.title=j;i.rec.commit();i.setTitle(j)}}},customEditors:{description:{xtype:"descriptionfield"},driver:Ext.create("Ext.form.ComboBox",{store:workspaceDatasources.drivers,queryMode:"local",displayField:"title",valueField:"value"}),password:{inputType:"password"}},customRenderers:{driver:function(g){workspaceDatasources.drivers.findBy(function(h){if(h.get("value")===g){g=h.get("title");return true}});return g},description:function(g){var j=Ext.decode(g),k=j.description_details,h=j.description_resume,i="";i+="<b>"+h+"</b>: ";i+="<i>"+k+"</i>";return i},password:function(g){return Array(g.length).join("*")}},source:workspaceDatasources.propertySource});propertyPanel.add(workspaceDatasources.propertyData);propertyPanel.add(aboutTab());propertyPanel.setActiveTab(workspaceDatasources.propertyData);var f=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1},{text:"Titre de la colonne",flex:1,sortable:1},{text:"Cadrage",flex:1,sortable:1},{text:"Format de date",flex:1,sortable:1},{text:"Largeur de la colonne",flex:1,sortable:1}]});var e=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1}]});bottomPanel.removeAll();var c=Ext.create("Ext.Panel",{title:"Paramètres d'affichage des colonnes",iconCls:"tabs",closable:false,items:[f]});var a=Ext.create("Ext.Panel",{title:"Résultats sources de données",iconCls:"tabs",html:"center south",closable:false,items:[e]});bottomPanel.add(c);bottomPanel.add(a);bottomPanel.setActiveTab(c);d()},getDatasource:function(b,a){symfony("get","datasource","datasource",{id:b},function(c){if(workspaceDatasources.datasources[c.data.Id]===undefined){workspaceDatasources.datasources[c.data.Id]={}}a(c.data)})},task:function(c){switch(c.key){case"save":var d=workspaceDatasources.propertyData.source["(name)"];workspaceDatasources.current.title=d;workspaceDatasources.current.driver=workspaceDatasources.propertyData.source.driver;workspaceDatasources.current.host=workspaceDatasources.propertyData.source.host;workspaceDatasources.current.datastore=workspaceDatasources.propertyData.source.datastore;workspaceDatasources.current.user=workspaceDatasources.propertyData.source.user;workspaceDatasources.current.password=workspaceDatasources.propertyData.source.password;var b={id:workspaceDatasources.current.Id,title:workspaceDatasources.current.title,groupid:workspaceDatasources.current.groupid,driver:workspaceDatasources.current.driver,host:workspaceDatasources.current.host,datastore:workspaceDatasources.current.datastore,user:workspaceDatasources.current.user,password:workspaceDatasources.current.password};var a=new Ext.LoadMask(centerPanel,{msg:"Sauvegarde en cours ..."});a.show();symfony("save","datasource","datasource",b,function(e){a.hide()});break}}};