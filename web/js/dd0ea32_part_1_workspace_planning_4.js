Ext.require(["Ext.TabPanel","Extensible.calendar.data.MemoryEventStore","Extensible.calendar.CalendarPanel"]);var clipboardPlannings=undefined;var workspacePlannings={name:"plannings",current:null,plannings:[],propertyData:null,properySource:null,storecouleur:null,init:function(){Ext.define("treeModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"nodek",type:"string"},{name:"text",type:"string"},{name:"groupid",type:"int"}]});Extensible.calendar.data.EventMappings={EventId:{name:"ID",mapping:"Id"},CalendarId:{name:"CalID",mapping:"usergroupid"},Title:{name:"EvtTitle",mapping:"title"},StartDate:{name:"StartDt",mapping:"startdate",type:"date"},EndDate:{name:"EndDt",mapping:"enddate",type:"date"},RRule:{name:"RecurRule",mapping:"recurrule"},Location:{name:"Location",mapping:"location"},Notes:{name:"Desc",mapping:"notes"},Url:{name:"LinkUrl",mapping:"url"},IsAllDay:{name:"AllDay",mapping:"isallday",type:"boolean"},Reminder:{name:"Reminder",mapping:"reminder"},ReportId:{name:"ReportId",mapping:"reportid",type:"int"},CreatedBy:{name:"CreatedBy",mapping:"createdby"}};Extensible.calendar.data.EventModel.reconfigure();Extensible.calendar.data.CalendarMappings={CalendarId:{name:"ID",mapping:"cal_id"},Title:{name:"CalTitle",mapping:"cal_title",type:"string"},Description:{name:"Desc",mapping:"cal_desc",type:"string"},ColorId:{name:"Color",mapping:"cal_color",type:"int"},IsHidden:{name:"Hidden",mapping:"hidden",type:"boolean"}};Extensible.calendar.data.CalendarModel.reconfigure();symfony("listall","report","report",{},function(a){dataReports=a.data;Ext.override(Extensible.calendar.form.EventWindow,{titleTextAdd:"Programmer une génération automatique de rapport",labelWidth:150,width:760,initRefs:function(){this.callParent();this.reportField=this.down("#"+this.id+"-report")},show:function(d,c){this.callParent(arguments);var e=Extensible.calendar.data.EventMappings;if(d.data){var b=d;this.reportField.setValue(b.data[e.ReportId.name])}},getFooterBarConfig:function(){this.enableEditDetails=false;return this.callParent()},getFormItemConfigs:function(){var b=[{xtype:"textfield",itemId:this.id+"-title",name:Extensible.calendar.data.EventMappings.Title.name,fieldLabel:this.titleLabelText,anchor:"100%"},{xtype:"extensible.daterangefield",itemId:this.id+"-dates",name:"dates",anchor:"95%",singleLine:true,fieldLabel:this.datesLabelText},{itemId:this.id+"-report",anchor:"100%",fieldLabel:"Rapport",xtype:"groupingcombobox",name:Extensible.calendar.data.EventMappings.ReportId.name,allowBlank:false,groupField:["grouptree"],valueField:"Id",displayField:"text",displaySeparator:" ❱ ",queryMode:"local",editable:false,typeAhead:true,store:{fields:[{name:"Id",type:"int"},{name:"grouptree",type:"string"},{name:"text",type:"string"}],sorters:[{property:"grouptree",direction:"ASC"}],data:dataReports}}];if(this.calendarStore){b.push({xtype:"extensible.calendarcombo",itemId:this.id+"-calendar",editable:false,forceSelection:true,allowBlank:false,name:Extensible.calendar.data.EventMappings.CalendarId.name,anchor:"100%",fieldLabel:"Groupe d'utilisateurs",store:this.calendarStore})}return b}})})},menuPlannings:new Ext.menu.Menu({items:[{text:"Modifier la tâche plannifiée",key:"modplanning"},{text:"Supprimer la tâche plannifiée",key:"delplanning"},{xtype:"menuseparator"},{text:"Copier",key:"copyplanning"},{text:"Couper",key:"cutplanning"}],listeners:{click:function(c,a){switch(a.key){case"modplanning":workspacePlannings.gotoPlanning(workspacePlannings.menuPlannings.rec);break;case"delplanning":var b=workspacePlannings.menuPlannings.rec;Ext.MessageBox.show({title:"Totem : Suppression de tâche plannifiée",msg:"Etes-vous certain de vouloir supprimer la tâche plannifiée [ "+b.raw.title+" ] ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspacePlannings.itemPlannings,{msg:"Suppression en cours ..."});e.show();symfony("delete","planning","planning",{id:b.raw.Id},function(g){b.remove(true);workspacePlannings.autoCloseCenterTab();f.hide();e.hide()})}}});break;case"copyplanning":workspacePlannings.copy(workspacePlannings.menuPlannings.rec);break;case"cutplanning":workspacePlannings.cut(workspacePlannings.menuPlannings.rec);break}}}}),menuGroupPlannings:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{text:"Modifier ce groupe",key:"modgroup"},{text:"Supprimer ce groupe",key:"delgroup"},{xtype:"menuseparator"},{text:"Copier",key:"copygroup"},{text:"Couper",key:"cutgroup"},{id:"planningpaste",text:"Coller",key:"paste",disabled:true},{xtype:"menuseparator"},{text:"Ajouter une tâche plannifiée",key:"addplanning"}],listeners:{click:function(c,a){switch(a.key){case"copygroup":workspacePlannings.copy(workspacePlannings.menuGroupPlannings.rec);break;case"cutgroup":workspacePlannings.cut(workspacePlannings.menuGroupPlannings.rec);break;case"addplanning":workspacePlannings.newPlanning(workspacePlannings.menuGroupPlannings.rec);break;case"paste":workspacePlannings.paste(workspacePlannings.menuGroupPlannings.rec);break;case"addgroup":workspacePlannings.groupForm.load("Nouveau groupe","new",workspacePlannings.menuGroupPlannings.rec).show();break;case"modgroup":workspacePlannings.groupForm.load("Modifier un groupe","update",workspacePlannings.menuGroupPlannings.rec).show();break;case"delgroup":var b=workspacePlannings.menuGroupPlannings.rec;Ext.MessageBox.show({title:"Totem : Suppression de groupe",msg:"Etes-vous certain de vouloir supprimer le groupe [ "+b.raw.title+" ] et tous les éléments qu'il contient ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspacePlannings.itemPlannings,{msg:"Suppression en cours ..."});e.show();symfony("delete","group","planning",{id:b.raw.Id},function(g){b.remove(true);workspacePlannings.autoCloseCenterTab();f.hide();e.hide()})}}});break}}}}),copy:function(a){clipboardPlannings={item:a,action:"copy"};Ext.getCmp("planningpaste").setDisabled(false);if(a.raw.nodek=="groupplanning"){Ext.getCmp("planningpasteroot").setDisabled(false)}},cut:function(a){clipboardPlannings={item:a,action:"cut"};Ext.getCmp("planningpaste").setDisabled(false);if(a.raw.nodek=="groupplanning"){Ext.getCmp("planningpasteroot").setDisabled(false)}},paste:function(d){var b=clipboardPlannings.item;if(clipboardPlannings.action=="cut"){if(clipboardPlannings.item.raw.nodek=="planning"){var a={id:clipboardPlannings.item.raw.Id,groupid:d.raw.Id};symfony("save","planning","planning",a,function(e){if(workspacePlannings.current!=null&&workspacePlannings.current.Id==a.id){workspacePlannings.current.groupid=a.groupid}d.appendChild(b)})}else{if(clipboardPlannings.item.raw.nodek=="groupplanning"){var c={id:clipboardPlannings.item.raw.Id,groupid:d.raw.Id};symfony("save","group","planning",c,function(e){d.appendChild(b)})}}}else{if(clipboardPlannings.item.raw.nodek=="planning"){var a={id:clipboardPlannings.item.raw.Id,groupid:d.raw.Id};symfony("clone","planning","planning",a,function(e){d.appendChild(e.data)})}else{if(clipboardPlannings.item.raw.nodek=="groupplanning"){var c={id:clipboardPlannings.item.raw.Id,groupid:d.raw.Id};symfony("clone","group","planning",c,function(e){d.appendChild(e.data)})}}}clipboardPlannings=null;Ext.getCmp("planningpaste").setDisabled(true);Ext.getCmp("planningpasteroot").setDisabled(true)},menuRootGroupPlannings:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{xtype:"menuseparator"},{id:"planningpasteroot",text:"Coller",key:"paste",disabled:true}],listeners:{click:function(b,a){switch(a.key){case"addgroup":workspacePlannings.groupForm.load("Nouveau groupe","new",workspacePlannings.menuGroupPlannings.rec).show();break;case"paste":workspacePlannings.paste(workspacePlannings.menuGroupPlannings.rec);break}}}}),groupForm:{load:function(f,c,e){var d=null;var b=null;if(c=="new"){d={raw:{Id:0,title:"",text:""}};b=e}if(c=="update"){d=e;b=e.parentNode}var a=new Ext.form.Panel({defaults:{labelWidth:150},width:500,height:400,title:f,floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Name",name:"name",value:d.raw.title},{xtype:"displayfield",fieldLabel:"Parent",name:"parent",value:(b.raw.Id==0||b.raw.Id==null)?"(Racine)":b.raw.title},{xtype:"tabpanel",flex:1,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",items:[{title:"Info",items:[{xtype:"textfield",fieldLabel:"Country",name:"country"}]},{title:"Contact",items:[{xtype:"textfield",fieldLabel:"Email",name:"email"}]}]}],buttons:[{text:"Enregistrer",handler:function(){var h=a.items.get("name").value;var g=(b.raw.Id)?b.raw.Id:0;group={id:d.raw.Id,title:h,groupid:g};symfony("save","group","planning",group,function(i){if(c=="new"){b.insertChild(-1,{Id:i.data.Id,title:group.title,text:group.title});if(!b.isExpanded()){b.expand()}}if(c=="update"){d.set("text",group.title);d.raw.text=group.title;d.raw.title=group.title;d.commit()}a.close()})}},{text:"Annuler",handler:function(){a.close()}}]});return a}},autoCloseCenterTab:function(){centerPanel.items.each(function(b,a,d){if("planning" in b&&b.planning.Id!=0){var c={id:b.planning.Id};symfony("exists","planning","planning",c,function(e){if(e.data.response=="false"){if(workspacePlannings.current.Id==c.id){workspacePlannings.current=null}centerPanel.remove(b)}})}})},newPlanning:function(b){var a={groupid:b.raw.Id,title:"Nouvelle tâche plannifiée"};symfony("save","planning","planning",a,function(c){var d=b.insertChild(-1,c.data);workspacePlannings.gotoPlanning(d)})},gotoPlanning:function(a){workspacePlannings.getPlanning(a.raw.Id,function(c){var b=false;centerPanel.items.each(function(e,d,f){if(e.planning&&c.Id==e.planning.Id){b=true;centerPanel.setActiveTab(e)}});if(!b){symfony("get","events","planning",{planningid:a.raw.Id},function(d){var e=d.data;Ext.define("Extensible.totem.calendar.data.Events",{constructor:function(){return{evts:e}}});symfony("list","group","user",{},function(f){var h=f.data;Ext.define("Extensible.totem.calendar.data.Calendar",{constructor:function(){var j=[];$.each(h,function(m,n){var l=Math.abs(n.color.replace("x-cal-","").replace("-ad",""))+0;var k={cal_id:n.Id,cal_color:l,cal_title:n.text};j.push(k)});return{calendars:j}}});var g=Ext.create("Extensible.calendar.data.MemoryEventStore",{data:Ext.create("Extensible.totem.calendar.data.Events")});workspacePlannings.calendarStore=Ext.create("Extensible.calendar.data.MemoryCalendarStore",{data:Ext.create("Extensible.totem.calendar.data.Calendar")});var i=Ext.create("Ext.Panel",{title:a.raw.text,iconCls:"icon-planning",closable:true,active:true,tbar:[{text:"Enregistrer",key:"save",handler:workspacePlannings.task},{text:"Analyser",key:"analyse",handler:workspacePlannings.task},{text:"Exécuter",key:"run",handler:workspacePlannings.task}],items:[{xtype:"extensible.calendarpanel",eventStore:g,calendarStore:workspacePlannings.calendarStore,height:1098,activeItem:1,editModal:true,listeners:{eventclick:{fn:function(l,j,k){},scope:this},dayclick:{fn:function(m,l,k,j){},scope:this},eventupdate:{fn:function(l,k){var j={id:k.data[Extensible.calendar.data.EventMappings.EventId.name],title:k.data[Extensible.calendar.data.EventMappings.Title.name],planningid:a.raw.Id,usergroupid:k.data[Extensible.calendar.data.EventMappings.CalendarId.name],startdate:""+k.data[Extensible.calendar.data.EventMappings.StartDate.name],enddate:""+k.data[Extensible.calendar.data.EventMappings.EndDate.name],recurrule:k.data[Extensible.calendar.data.EventMappings.RRule.name],location:k.data[Extensible.calendar.data.EventMappings.Location.name],notes:k.data[Extensible.calendar.data.EventMappings.Notes.name],url:k.data[Extensible.calendar.data.EventMappings.Url.name],isallday:k.data[Extensible.calendar.data.EventMappings.IsAllDay.name],reminder:k.data[Extensible.calendar.data.EventMappings.Reminder.name],reportid:k.data[Extensible.calendar.data.EventMappings.ReportId.name],createdby:k.data[Extensible.calendar.data.EventMappings.CreatedBy.name]};symfony("save","event","planning",j,function(m){})},scope:this},eventadd:{fn:function(l,k){var j={title:k.data[Extensible.calendar.data.EventMappings.Title.name],planningid:a.raw.Id,usergroupid:k.data[Extensible.calendar.data.EventMappings.CalendarId.name],startdate:""+k.data[Extensible.calendar.data.EventMappings.StartDate.name],enddate:""+k.data[Extensible.calendar.data.EventMappings.EndDate.name],recurrule:k.data[Extensible.calendar.data.EventMappings.RRule.name],location:k.data[Extensible.calendar.data.EventMappings.Location.name],notes:k.data[Extensible.calendar.data.EventMappings.Notes.name],url:k.data[Extensible.calendar.data.EventMappings.Url.name],isallday:k.data[Extensible.calendar.data.EventMappings.IsAllDay.name],reminder:k.data[Extensible.calendar.data.EventMappings.Reminder.name],reportid:k.data[Extensible.calendar.data.EventMappings.ReportId.name],createdby:k.data[Extensible.calendar.data.EventMappings.CreatedBy.name]};symfony("save","event","planning",j,function(m){k.data[Extensible.calendar.data.EventMappings.EventId.name]=m.data.Id})},scope:this},eventdelete:{fn:function(k,j){this.eventStore.remove(j);alert(j.data[Extensible.calendar.data.EventMappings.Title.name])},scope:this}}}]});i.planning=a.raw;i.rec=a;i.workspace=workspacePlannings;i.propertySource={"(name)":c.title,description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};centerPanel.add(i);centerPanel.setActiveTab(i)})})}})},onCenterTabChange:function(b,a){if("planning" in a){workspacePlannings.current=a.planning;workspacePlannings.propertyData.setSource(a.propertySource)}},itemPlannings:Ext.create("Ext.tree.Panel",{title:"Tâches plannifiées",store:Ext.create("Ext.data.TreeStore",{model:"treeModel",proxy:{type:"memory"}}),viewConfig:{plugins:{ptype:"treeviewdragdrop"},listeners:{beforedrop:function(d,f,e,b,a,c){if((b=="before"||b=="after")&&e.parentNode.raw.text=="Root"){if(f.records[0].raw.nodek=="planning"){a.cancelDrop()}}},drop:function(c,e,d,a){if(e.records[0].raw.nodek=="groupplanning"){var f={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","group","planning",f,function(g){})}else{if(e.records[0].raw.nodek=="planning"){var b={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","planning","planning",b,function(g){if(workspacePlannings.current.Id==b.id){workspacePlannings.current.groupid=b.groupid}})}}}}},rootVisible:false,listeners:{afterrender:function(a,b){var c=new Ext.LoadMask(workspacePlannings.itemPlannings,{msg:"Veuillez patienter ..."});c.show();symfony("list","planning","planning",{},function(d){var f=workspacePlannings.itemPlannings.getStore();var e=f.setRootNode({children:d.data});Ext.apply(workspacePlannings.itemPlannings,{store:f});c.hide()})},itemdblclick:function(c,f,e,d,a){if(f.get("leaf")){var b=new Ext.LoadMask(centerPanel,{msg:"Chargement en cours ..."});b.show();symfony("get","planning","planning",{id:f.raw.Id},function(g){f.raw=g.data;workspacePlannings.gotoPlanning(f);b.hide()})}},containercontextmenu:function(b,a){workspacePlannings.menuGroupPlannings.rec=workspacePlannings.itemPlannings.store.tree.root;workspacePlannings.menuRootGroupPlannings.showAt(a.getXY());a.stopEvent()},itemcontextmenu:function(b,e,d,c,a){if(e.get("leaf")){workspacePlannings.menuPlannings.rec=e;workspacePlannings.menuPlannings.showAt(a.getXY())}else{workspacePlannings.menuGroupPlannings.rec=e;workspacePlannings.menuGroupPlannings.showAt(a.getXY())}a.stopEvent()}}}),setProperties:function(a){$.each(a,function(b,c){workspacePlannings.propertySource[b]=c});workspacePlannings.propertyData.setSource(workspacePlannings.propertySource)},set:function(b,d){currentWorkspace=workspacePlannings;bottomPanel.hide();propertyPanel.removeAll();workspacePlannings.propertySource={"(name)":"name",description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};workspacePlannings.propertyData=Ext.create("Ext.grid.property.Grid",{title:"Propriétés",propertyNames:{"(name)":"(Nom)",description:"Description",motscles:"Mots clés",environnement:"Environnement",nodek:"Groupe",publiee:"Publiée"},listeners:{propertychange:function(k,h,j,g){if(h=="(name)"){var i=centerPanel.getActiveTab();i.rec.set("text",j);i.rec.raw.text=j;i.rec.raw.title=j;i.rec.commit();i.setTitle(j)}}},customEditors:{description:{xtype:"descriptionfield"},groupe:{xtype:"combobox"},environnement:{xtype:"combobox"}},customRenderers:{description:function(g){var j=Ext.decode(g),k=j.description_details,h=j.description_resume,i="";i+="<b>"+h+"</b>: ";i+="<i>"+k+"</i>";return i}},source:workspacePlannings.propertySource});propertyPanel.add(workspacePlannings.propertyData);propertyPanel.add(aboutTab());propertyPanel.setActiveTab(workspacePlannings.propertyData);var f=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1},{text:"Titre de la colonne",flex:1,sortable:1},{text:"Cadrage",flex:1,sortable:1},{text:"Format de date",flex:1,sortable:1},{text:"Largeur de la colonne",flex:1,sortable:1}]});var e=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1}]});bottomPanel.removeAll();var c=Ext.create("Ext.Panel",{title:"Paramètres d'affichage des colonnes",iconCls:"tabs",closable:false,items:[f]});var a=Ext.create("Ext.Panel",{title:"Résultats tâches plannifiées",iconCls:"tabs",html:"center south",closable:false,items:[e]});bottomPanel.add(c);bottomPanel.add(a);bottomPanel.setActiveTab(c);d()},getPlanning:function(b,a){symfony("get","planning","planning",{id:b},function(c){if(workspacePlannings.plannings[c.data.Id]===undefined){workspacePlannings.plannings[c.data.Id]={}}a(c.data)})},task:function(b){switch(b.key){case"save":var d=workspacePlannings.propertyData.source["(name)"];workspacePlannings.current.title=d;var c={id:workspacePlannings.current.Id,title:workspacePlannings.current.title,groupid:workspacePlannings.current.groupid};var a=new Ext.LoadMask(centerPanel,{msg:"Sauvegarde en cours ..."});a.show();symfony("save","planning","planning",c,function(e){a.hide()});break}}};