var clipboardSettings=undefined;var workspaceSettings={name:"settings",current:null,settings:[],propertyData:null,properySource:null,init:function(){Ext.define("treeModel",{extend:"Ext.data.Model",fields:[{name:"Id",type:"int"},{name:"title",type:"string"},{name:"nodek",type:"string"},{name:"text",type:"string"},{name:"groupid",type:"int"}]})},menuSettings:new Ext.menu.Menu({items:[{text:"Modifier la configuration",key:"modsetting"},{text:"Supprimer la configuration",key:"delsetting"},{xtype:"menuseparator"},{text:"Copier",key:"copysetting"},{text:"Couper",key:"cutsetting"}],listeners:{click:function(c,a){switch(a.key){case"modsetting":workspaceSettings.gotoSetting(workspaceSettings.menuSettings.rec);break;case"delsetting":var b=workspaceSettings.menuSettings.rec;Ext.MessageBox.show({title:"Totem : Suppression de configuration",msg:"Etes-vous certain de vouloir supprimer la configuration [ "+b.raw.title+" ] ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceSettings.itemSettings,{msg:"Suppression en cours ..."});e.show();symfony("delete","setting","setting",{id:b.raw.Id},function(g){b.remove(true);workspaceSettings.autoCloseCenterTab();f.hide();e.hide()})}}});break;case"copysetting":workspaceSettings.copy(workspaceSettings.menuSettings.rec);break;case"cutsetting":workspaceSettings.cut(workspaceSettings.menuSettings.rec);break}}}}),menuGroupSettings:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{text:"Modifier ce groupe",key:"modgroup"},{text:"Supprimer ce groupe",key:"delgroup"},{xtype:"menuseparator"},{text:"Copier",key:"copygroup"},{text:"Couper",key:"cutgroup"},{id:"settingpaste",text:"Coller",key:"paste",disabled:true},{xtype:"menuseparator"},{text:"Ajouter une configuration",key:"addsetting"}],listeners:{click:function(c,a){switch(a.key){case"copygroup":workspaceSettings.copy(workspaceSettings.menuGroupSettings.rec);break;case"cutgroup":workspaceSettings.cut(workspaceSettings.menuGroupSettings.rec);break;case"addsetting":workspaceSettings.newSetting(workspaceSettings.menuGroupSettings.rec);break;case"paste":workspaceSettings.paste(workspaceSettings.menuGroupSettings.rec);break;case"addgroup":workspaceSettings.groupForm.load("Nouveau groupe","new",workspaceSettings.menuGroupSettings.rec).show();break;case"modgroup":workspaceSettings.groupForm.load("Modifier un groupe","update",workspaceSettings.menuGroupSettings.rec).show();break;case"delgroup":var b=workspaceSettings.menuGroupSettings.rec;Ext.MessageBox.show({title:"Totem : Suppression de groupe",msg:"Etes-vous certain de vouloir supprimer le groupe [ "+b.raw.title+" ] et tous les éléments qu'il contient ?",width:400,buttons:Ext.MessageBox.YESNO,buttonText:{yes:"Oui",no:"Non"},fn:function(d){if(d=="yes"){var f=new Ext.LoadMask(centerPanel,{msg:"Suppression en cours ..."});f.show();var e=new Ext.LoadMask(workspaceSettings.itemSettings,{msg:"Suppression en cours ..."});e.show();symfony("delete","group","setting",{id:b.raw.Id},function(g){b.remove(true);workspaceSettings.autoCloseCenterTab();f.hide();e.hide()})}}});break}}}}),copy:function(a){clipboardSettings={item:a,action:"copy"};Ext.getCmp("settingpaste").setDisabled(false);if(a.raw.nodek=="groupsetting"){Ext.getCmp("settingpasteroot").setDisabled(false)}},cut:function(a){clipboardSettings={item:a,action:"cut"};Ext.getCmp("settingpaste").setDisabled(false);if(a.raw.nodek=="groupsetting"){Ext.getCmp("settingpasteroot").setDisabled(false)}},paste:function(d){var b=clipboardSettings.item;if(clipboardSettings.action=="cut"){if(clipboardSettings.item.raw.nodek=="setting"){var a={id:clipboardSettings.item.raw.Id,groupid:d.raw.Id};symfony("save","setting","setting",a,function(e){if(workspaceSettings.current!=null&&workspaceSettings.current.Id==a.id){workspaceSettings.current.groupid=a.groupid}d.appendChild(b)})}else{if(clipboardSettings.item.raw.nodek=="groupsetting"){var c={id:clipboardSettings.item.raw.Id,groupid:d.raw.Id};symfony("save","group","setting",c,function(e){d.appendChild(b)})}}}else{if(clipboardSettings.item.raw.nodek=="setting"){var a={id:clipboardSettings.item.raw.Id,groupid:d.raw.Id};symfony("clone","setting","setting",a,function(e){d.appendChild(e.data)})}else{if(clipboardSettings.item.raw.nodek=="groupsetting"){var c={id:clipboardSettings.item.raw.Id,groupid:d.raw.Id};symfony("clone","group","setting",c,function(e){d.appendChild(e.data)})}}}clipboardSettings=null;Ext.getCmp("settingpaste").setDisabled(true);Ext.getCmp("settingpasteroot").setDisabled(true)},menuRootGroupSettings:new Ext.menu.Menu({items:[{text:"Ajouter un groupe",key:"addgroup"},{xtype:"menuseparator"},{id:"settingpasteroot",text:"Coller",key:"paste",disabled:true}],listeners:{click:function(b,a){switch(a.key){case"addgroup":workspaceSettings.groupForm.load("Nouveau groupe","new",workspaceSettings.menuGroupSettings.rec).show();break;case"paste":workspaceSettings.paste(workspaceSettings.menuGroupSettings.rec);break}}}}),groupForm:{load:function(f,c,e){var d=null;var b=null;if(c=="new"){d={raw:{Id:0,title:"",text:""}};b=e}if(c=="update"){d=e;b=e.parentNode}var a=new Ext.form.Panel({defaults:{labelWidth:150},width:500,height:400,title:f,floating:true,closable:true,modal:true,frame:true,bodyStyle:"padding: 10px 10px 0 10px; background-color:#dfeaf2",layout:{type:"vbox",align:"stretch"},items:[{id:"name",xtype:"textfield",fieldLabel:"Name",name:"name",value:d.raw.title},{xtype:"displayfield",fieldLabel:"Parent",name:"parent",value:(b.raw.Id==0||b.raw.Id==null)?"(Racine)":b.raw.title},{xtype:"tabpanel",flex:1,frame:true,bodyStyle:"padding: 10px 10px 0 10px;",items:[{title:"Info",items:[{xtype:"textfield",fieldLabel:"Country",name:"country"}]},{title:"Contact",items:[{xtype:"textfield",fieldLabel:"Email",name:"email"}]}]}],buttons:[{text:"Enregistrer",handler:function(){var h=a.items.get("name").value;var g=(b.raw.Id)?b.raw.Id:0;group={id:d.raw.Id,title:h,groupid:g};symfony("save","group","setting",group,function(i){if(c=="new"){b.insertChild(-1,{Id:i.data.Id,title:group.title,text:group.title});if(!b.isExpanded()){b.expand()}}if(c=="update"){d.set("text",group.title);d.raw.text=group.title;d.raw.title=group.title;d.commit()}a.close()})}},{text:"Annuler",handler:function(){a.close()}}]});return a}},autoCloseCenterTab:function(){centerPanel.items.each(function(c,a,d){if("setting" in c&&c.setting.Id!=0){var b={id:c.setting.Id};symfony("exists","setting","setting",b,function(e){if(e.data.response=="false"){if(workspaceSettings.current.Id==b.id){workspaceSettings.current=null}centerPanel.remove(c)}})}})},newSetting:function(b){var a={groupid:b.raw.Id,title:"Nouvelle configuration"};symfony("save","setting","setting",a,function(c){var d=b.insertChild(-1,c.data);workspaceSettings.gotoSetting(d)})},gotoSetting:function(a){workspaceSettings.getSetting(a.raw.Id,function(c){var b=false;centerPanel.items.each(function(f,e,g){if(f.setting&&c.Id==f.setting.Id){b=true;centerPanel.setActiveTab(f)}});if(!b){var d=Ext.create("Ext.Panel",{title:a.raw.text,iconCls:"icon-setting",html:"contenu",closable:true,active:true,tbar:[{text:"Enregistrer",key:"save",handler:workspaceSettings.task},{text:"Analyser",key:"analyse",handler:workspaceSettings.task},{text:"Exécuter",key:"run",handler:workspaceSettings.task}]});d.setting=a.raw;d.rec=a;d.workspace=workspaceSettings;d.propertySource={"(name)":c.title,description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};centerPanel.add(d);centerPanel.setActiveTab(d)}})},onCenterTabChange:function(b,a){if("setting" in a){workspaceSettings.current=a.setting;workspaceSettings.propertyData.setSource(a.propertySource)}},itemSettings:Ext.create("Ext.tree.Panel",{title:"Configurations",store:Ext.create("Ext.data.TreeStore",{model:"treeModel",proxy:{type:"memory"}}),viewConfig:{plugins:{ptype:"treeviewdragdrop"},listeners:{beforedrop:function(d,f,e,b,a,c){if((b=="before"||b=="after")&&e.parentNode.raw.text=="Root"){if(f.records[0].raw.nodek=="setting"){a.cancelDrop()}}},drop:function(c,e,d,a){if(e.records[0].raw.nodek=="groupsetting"){var f={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","group","setting",f,function(g){})}else{if(e.records[0].raw.nodek=="setting"){var b={id:e.records[0].raw.Id,groupid:d.raw.Id};symfony("save","setting","setting",b,function(g){if(workspaceSettings.current.Id==b.id){workspaceSettings.current.groupid=b.groupid}})}}}}},rootVisible:false,listeners:{afterrender:function(a,b){var c=new Ext.LoadMask(workspaceSettings.itemSettings,{msg:"Veuillez patienter ..."});c.show();symfony("list","setting","setting",{},function(d){var f=workspaceSettings.itemSettings.getStore();var e=f.setRootNode({children:d.data});Ext.apply(workspaceSettings.itemSettings,{store:f});c.hide()})},itemdblclick:function(c,f,e,d,a){if(f.get("leaf")){var b=new Ext.LoadMask(centerPanel,{msg:"Chargement en cours ..."});b.show();symfony("get","setting","setting",{id:f.raw.Id},function(g){f.raw=g.data;workspaceSettings.gotoSetting(f);b.hide()})}},containercontextmenu:function(b,a){workspaceSettings.menuGroupSettings.rec=workspaceSettings.itemSettings.store.tree.root;workspaceSettings.menuRootGroupSettings.showAt(a.getXY());a.stopEvent()},itemcontextmenu:function(b,e,d,c,a){if(e.get("leaf")){workspaceSettings.menuSettings.rec=e;workspaceSettings.menuSettings.showAt(a.getXY())}else{workspaceSettings.menuGroupSettings.rec=e;workspaceSettings.menuGroupSettings.showAt(a.getXY())}a.stopEvent()}}}),setProperties:function(a){$.each(a,function(b,c){workspaceSettings.propertySource[b]=c});workspaceSettings.propertyData.setSource(workspaceSettings.propertySource)},set:function(b,d){currentWorkspace=workspaceSettings;bottomPanel.hide();propertyPanel.removeAll();workspaceSettings.propertySource={"(name)":"name",description:Ext.encode({description_resume:"",description_details:""}),motscles:"",environnement:"",nodek:"",publiee:true};workspaceSettings.propertyData=Ext.create("Ext.grid.property.Grid",{title:"Propriétés",propertyNames:{"(name)":"(Nom)",description:"Description",motscles:"Mots clés",environnement:"Environnement",nodek:"Groupe",publiee:"Publiée"},listeners:{propertychange:function(k,h,j,g){if(h=="(name)"){var i=centerPanel.getActiveTab();i.rec.set("text",j);i.rec.raw.text=j;i.rec.raw.title=j;i.rec.commit();i.setTitle(j)}}},customEditors:{description:{xtype:"descriptionfield"},groupe:{xtype:"combobox"},environnement:{xtype:"combobox"}},customRenderers:{description:function(g){var j=Ext.decode(g),k=j.description_details,h=j.description_resume,i="";i+="<b>"+h+"</b>: ";i+="<i>"+k+"</i>";return i}},source:workspaceSettings.propertySource});propertyPanel.add(workspaceSettings.propertyData);propertyPanel.add(aboutTab());propertyPanel.setActiveTab(workspaceSettings.propertyData);var f=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1},{text:"Titre de la colonne",flex:1,sortable:1},{text:"Cadrage",flex:1,sortable:1},{text:"Format de date",flex:1,sortable:1},{text:"Largeur de la colonne",flex:1,sortable:1}]});var e=Ext.create("Ext.grid.Panel",{columnLines:true,columns:[{text:"Ordre",flex:1,sortable:1},{text:"Nom SQL",flex:1,sortable:1}]});bottomPanel.removeAll();var c=Ext.create("Ext.Panel",{title:"Paramètres d'affichage des colonnes",iconCls:"tabs",closable:false,items:[f]});var a=Ext.create("Ext.Panel",{title:"Résultats configurations",iconCls:"tabs",html:"center south",closable:false,items:[e]});bottomPanel.add(c);bottomPanel.add(a);bottomPanel.setActiveTab(c);d()},getSetting:function(b,a){symfony("get","setting","setting",{id:b},function(c){if(workspaceSettings.settings[c.data.Id]===undefined){workspaceSettings.settings[c.data.Id]={}}a(c.data)})},task:function(b){switch(b.key){case"save":var d=workspaceSettings.propertyData.source["(name)"];workspaceSettings.current.title=d;var c={id:workspaceSettings.current.Id,title:workspaceSettings.current.title,groupid:workspaceSettings.current.groupid};var a=new Ext.LoadMask(centerPanel,{msg:"Sauvegarde en cours ..."});a.show();symfony("save","setting","setting",c,function(e){a.hide()});break}}};